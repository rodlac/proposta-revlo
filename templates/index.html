<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Cadastro de Pedido</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }

    .group {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: inline-block;
    }
    select, input[type="number"], input[type="text"] {
      width: 220px;
      margin-bottom: 5px;
      margin-right: 10px;
    }

    /* Tabela de produtos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background-color: #f9f9f9;
    }

    /* Botões */
    .btn {
      padding: 6px 12px;
      background: #007BFF;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 5px;
    }
    .btn:hover {
      background-color: #0056b3;
    }

    .btn-remove {
      background: #dc3545;
    }
    .btn-remove:hover {
      background-color: #bd2130;
    }

    /* Valor total final */
    .total-container {
      margin-top: 10px;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Cadastro de Pedido (Somente Locação)</h1>

  <form action="/gerar_pdf" method="POST" onsubmit="return enviarFormulario()">
    <!-- Se quiser que vá para /gerar_pdf, verifique se app.py está preparado p/ receber todos esses campos. -->

    <!-- Escolha do Período -->
    <div class="group">
      <label for="periodo">Período da Locação:</label><br>
      <select id="periodo" name="periodo" onchange="togglePeriodoPersonalizado()">
        <option value="7 dias">7 dias</option>
        <option value="15 dias">15 dias</option>
        <option value="30 dias">30 dias</option>
        <option value="Personalizado">Personalizado...</option>
      </select>
      <br>
      <!-- Campo visível somente quando a pessoa escolhe 'Personalizado' -->
      <input type="text" id="periodo_personalizado" name="periodo_personalizado"
             class="hidden" placeholder="Ex.: 45 dias ou outro texto">
    </div>

    <!-- Tabela de Produtos -->
    <table id="tabela-produtos">
      <thead>
        <tr>
          <th>Equipamento</th>
          <th>Quantidade</th>
          <th>Valor Unit. (R$)</th>
          <th>Valor Total (R$)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <!-- A primeira linha do produto, já presente por padrão -->
        <tr>
          <td>
            <select name="equipamento[]" onchange="calcularLinha(this)">
              <option value="Torre de Iluminação a Diesel">Torre de Iluminação a Diesel</option>
              <option value="Torre de Iluminação Solar">Torre de Iluminação Solar</option>
              <option value="PMV Móvel">PMV Móvel</option>
              <option value="Lombada Eletrônica">Lombada Eletrônica</option>
              <option value="Balança de Sapata">Balança de Sapata</option>
            </select>
          </td>
          <td>
            <input type="number" name="quantidade[]" value="1" min="1" oninput="calcularLinha(this)">
          </td>
          <td>
            <input type="number" step="any" name="valor_unitario[]" value="0" oninput="calcularLinha(this)">
          </td>
          <td>
            <input type="text" name="valor_total_linha[]" value="0" readonly>
          </td>
          <td>
            <button type="button" class="btn btn-remove" onclick="removerLinha(this)">Remover</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Botão para adicionar nova linha -->
    <button type="button" class="btn" onclick="adicionarLinha()">Adicionar Produto</button>

    <!-- Valor total de todas as linhas -->
    <div class="total-container">
      Valor Total Geral: R$ <span id="valor_total_geral">0</span>
    </div>

    <br>
    <!-- Campos do Cliente (ex: empresa, cnpj, etc.) -->
    <div class="group">
      <label for="empresa">Empresa:</label><br>
      <input type="text" id="empresa" name="empresa"><br><br>

      <label for="cnpj">CNPJ/CPF:</label><br>
      <input type="text" id="cnpj" name="cnpj"><br><br>

      <label for="ie">Inscrição Estadual:</label><br>
      <input type="text" id="ie" name="ie"><br><br>

      <label for="nome_contato">Nome do Contato:</label><br>
      <input type="text" id="nome_contato" name="nome_contato"><br><br>

      <label for="email">E-mail:</label><br>
      <input type="text" id="email" name="email"><br><br>

      <label for="telefone">Telefone:</label><br>
      <input type="text" id="telefone" name="telefone"><br><br>
    </div>

    <!-- Campo Oculto para mandar Valor Total Geral ao PDF -->
    <input type="hidden" id="valor_total_geral_input" name="valor_total_geral">

    <button type="submit" class="btn">Gerar PDF</button>
  </form>

  <script>
    // Exibe/esconde o campo periodo_personalizado
    function togglePeriodoPersonalizado() {
      const selectPeriodo = document.getElementById('periodo');
      const periodoPersonalizado = document.getElementById('periodo_personalizado');

      if (selectPeriodo.value === 'Personalizado') {
        periodoPersonalizado.classList.remove('hidden');
      } else {
        periodoPersonalizado.classList.add('hidden');
        periodoPersonalizado.value = ''; // limpa caso volte atrás
      }
    }

    // Adiciona uma nova linha na tabela
    function adicionarLinha() {
      const tabela = document.getElementById('tabela-produtos').querySelector('tbody');
      const novaLinha = document.createElement('tr');

      novaLinha.innerHTML = `
        <td>
          <select name="equipamento[]" onchange="calcularLinha(this)">
            <option value="Torre de Iluminação a Diesel">Torre de Iluminação a Diesel</option>
            <option value="Torre de Iluminação Solar">Torre de Iluminação Solar</option>
            <option value="PMV Móvel">PMV Móvel</option>
            <option value="Lombada Eletrônica">Lombada Eletrônica</option>
            <option value="Balança de Sapata">Balança de Sapata</option>
          </select>
        </td>
        <td>
          <input type="number" name="quantidade[]" value="1" min="1" oninput="calcularLinha(this)">
        </td>
        <td>
          <input type="number" step="any" name="valor_unitario[]" value="0" oninput="calcularLinha(this)">
        </td>
        <td>
          <input type="text" name="valor_total_linha[]" value="0" readonly>
        </td>
        <td>
          <button type="button" class="btn btn-remove" onclick="removerLinha(this)">Remover</button>
        </td>
      `;
      tabela.appendChild(novaLinha);
    }

    // Remove a linha atual
    function removerLinha(button) {
      const row = button.closest('tr');
      row.remove();
      calcularTotalGeral();
    }

    // Calcula o valor total de uma linha e depois o total geral
    function calcularLinha(element) {
      const row = element.closest('tr');
      const qtdInput = row.querySelector('input[name="quantidade[]"]');
      const unitInput = row.querySelector('input[name="valor_unitario[]"]');
      const totalInput = row.querySelector('input[name="valor_total_linha[]"]');

      const qtd = parseFloat(qtdInput.value) || 0;
      const unit = parseFloat(unitInput.value) || 0;
      const totalLinha = qtd * unit;

      totalInput.value = totalLinha.toFixed(2);

      calcularTotalGeral();
    }

    // Soma o valor total de todas as linhas
    function calcularTotalGeral() {
      const totalInputs = document.querySelectorAll('input[name="valor_total_linha[]"]');
      let soma = 0;
      totalInputs.forEach(input => {
        soma += parseFloat(input.value) || 0;
      });
      document.getElementById('valor_total_geral').textContent = soma.toFixed(2);
    }

    // Dispara quando o usuário clica em "Gerar PDF"
    // Copiamos o valor total geral para um hidden input
    function enviarFormulario() {
      const totalGeral = document.getElementById('valor_total_geral').textContent;
      document.getElementById('valor_total_geral_input').value = totalGeral;
      return true; // prossegue com o submit
    }
  </script>
</body>
</html>
