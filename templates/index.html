<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="robots" content="noindex, nofollow" />
  <title>Impressão de Orçamento em PDF</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body {
      margin: 20px;
      font-family: Arial, sans-serif;
    }
    .hidden {
      display: none !important;
    }
</style>
</head>
<body>
<div class="container">
  <h1>Orçamento em PDF</h1>
  <form action="/gerar_pdf" method="POST" onsubmit="return enviarFormulario()">

    <!-- Modalidade -->
    <div class="mb-3">
      <label>Modalidade:</label>
      <select class="form-control" id="modalidade" name="modalidade" onchange="toggleModalidade()">
        <option value="Locação">Locação</option>
        <option value="Venda">Venda</option>
      </select>
    </div>

    <!-- Período -->
    <div class="mb-3" id="campo-periodo">
      <label>Período da Locação:</label>
      <select class="form-control" id="periodo" name="periodo" onchange="togglePeriodoPersonalizado()">
        <option value="7 dias">7 dias</option>
        <option value="15 dias">15 dias</option>
        <option value="30 dias">30 dias</option>
        <option value="Personalizado">Personalizado...</option>
      </select>
      <input type="text" id="periodo_personalizado" name="periodo_personalizado" class="form-control hidden" placeholder="Ex.: 45 dias">
    </div>

    <!-- Tabela de Produtos -->
    <table class="table table-bordered" id="tabela-produtos">
      <thead>
        <tr>
          <th>Equipamento</th>
          <th>Quantidade</th>
          <th>Valor Unit. (R$)</th>
          <th>Valor Total (R$)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select class="form-control" name="equipamento[]" onchange="calcularLinha(this)">
              <option>Torre de Iluminação a Diesel</option>
              <option>Torre de Iluminação Solar</option>
              <option>PMV Móvel</option>
              <option>Lombada Eletrônica</option>
              <option>Balança de Sapata</option>
            </select>
          </td>
          <td><input class="form-control" type="number" name="quantidade[]" value="1" oninput="calcularLinha(this)"></td>
          <td><input type="number" step="any" name="valor_unitario[]" value="0" oninput="calcularLinha(this)"></td>
          <td><input type="text" name="valor_total_linha[]" value="0" readonly></td>
          <td><button type="button" class="btn btn-danger" onclick="removerLinha(this)">Remover</button></td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="btn btn-primary" onclick="adicionarLinha()">Adicionar Produto</button>

    <div class="mt-3"><strong>Valor Total Geral:</strong> R$ <span id="valor_total_geral">0.00</span></div>

    <div class="form-group">
      <label>Empresa:</label>
      <input type="text" class="form-control" name="empresa">

      <label>CNPJ/CPF:</label>
      <input type="text" class="form-control" name="cnpj">

      <label>Inscrição Estadual:</label>
      <input type="text" class="form-control" name="ie">

      <label>Nome do Contato:</label>
      <input type="text" class="form-control" name="nome_contato">

      <label>E-mail:</label>
      <input type="email" class="form-control" name="email">

      <label>Telefone:</label>
      <input type="text" class="form-control" name="telefone">

      <label>Vendedor:</label>
      <select class="form-control" name="vendedor">
        <option>Sara</option>
        <option>Carlos</option>
        <option>Caetana</option>
        <option>Luiz</option>
      </select>

      <label>Observação:</label>
      <textarea class="form-control" name="observacao" rows="4"></textarea>
    </div>

    <input type="hidden" id="valor_total_geral_input" name="valor_total_geral">

    <button type="submit" class="btn btn-primary">Gerar PDF</button>
  </form>
</div>

<!-- JS do Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function togglePeriodoPersonalizado() {
    const selectPeriodo = document.getElementById('periodo');
    const periodoPersonalizado = document.getElementById('periodo_personalizado');

    periodoPersonalizado.classList.toggle('hidden', selectPeriodo.value !== 'Personalizado');
  }

  function toggleModalidade() {
    const modalidade = document.getElementById('modalidade').value;
    const campoPeriodo = document.getElementById('campo-periodo');

    campoPeriodo.classList.toggle('hidden', modalidade !== 'Locação');
  }

  // Executa na carga inicial da página para garantir estado correto
  document.addEventListener('DOMContentLoaded', toggleModalidade);

    // Adiciona uma nova linha na tabela
    function adicionarLinha() {
      const tabela = document.getElementById('tabela-produtos').querySelector('tbody');
      const novaLinha = document.createElement('tr');

      novaLinha.innerHTML = `
        <td>
          <select name="equipamento[]" onchange="calcularLinha(this)">
            <option value="Torre de Iluminação a Diesel">Torre de Iluminação a Diesel</option>
            <option value="Torre de Iluminação Solar">Torre de Iluminação Solar</option>
            <option value="PMV Móvel">PMV Móvel</option>
            <option value="Lombada Eletrônica">Lombada Eletrônica</option>
            <option value="Balança de Sapata">Balança de Sapata</option>
          </select>
        </td>
        <td>
          <input type="number" name="quantidade[]" value="1" min="1" oninput="calcularLinha(this)">
        </td>
        <td>
          <input type="number" step="any" name="valor_unitario[]" value="0" oninput="calcularLinha(this)">
        </td>
        <td>
          <input type="text" name="valor_total_linha[]" value="0" readonly>
        </td>
        <td>
          <button type="button" class="btn btn-remove" onclick="removerLinha(this)">Remover</button>
        </td>
      `;
      tabela.appendChild(novaLinha);
    }

    // Remove a linha atual
    function removerLinha(button) {
      const row = button.closest('tr');
      row.remove();
      calcularTotalGeral();
    }

    // Calcula o valor total de uma linha e depois o total geral
    function calcularLinha(element) {
      const row = element.closest('tr');
      const qtdInput = row.querySelector('input[name="quantidade[]"]');
      const unitInput = row.querySelector('input[name="valor_unitario[]"]');
      const totalInput = row.querySelector('input[name="valor_total_linha[]"]');

      const qtd = parseFloat(qtdInput.value) || 0;
      const unit = parseFloat(unitInput.value) || 0;
      const totalLinha = qtd * unit;

      totalInput.value = totalLinha.toFixed(2);

      calcularTotalGeral();
    }

    // Soma o valor total de todas as linhas
    function calcularTotalGeral() {
      const totalInputs = document.querySelectorAll('input[name="valor_total_linha[]"]');
      let soma = 0;
      totalInputs.forEach(input => {
        soma += parseFloat(input.value) || 0;
      });
      document.getElementById('valor_total_geral').textContent = soma.toFixed(2);
    }

    // Dispara quando o usuário clica em "Gerar PDF"
    // Copiamos o valor total geral para um hidden input
    function enviarFormulario() {
      const totalGeral = document.getElementById('valor_total_geral').textContent;
      document.getElementById('valor_total_geral_input').value = totalGeral;
      return true; // prossegue com o submit
    }
  </script>
</body>
</html>
